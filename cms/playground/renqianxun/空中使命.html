<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç©ºä¸­ä½¿å‘½ - é˜²ç©ºç‚®æ‰“é£æœº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%);
            user-select: none;
            touch-action: none;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            border: 2px solid #4682B4;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            background: transparent;
            max-width: 100%;
            height: auto;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            width: 800px;
            max-width: 90vw;
            margin-bottom: 10px;
            color: #333;
            font-size: 18px;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            z-index: 10;
            position: relative;
        }

        .score, .lives, .ammo {
            background: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .game-over-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
        }

        .game-over-content {
            background: linear-gradient(135deg, #5c6bc0, #3949ab);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: white;
            max-width: 80%;
        }

        .game-over-content h2 {
            font-size: 36px;
            margin-bottom: 15px;
        }

        .game-over-content p {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .restart-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .restart-btn:hover {
            background: #66bb6a;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 100;
        }

        .movement-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .control-row {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(33, 150, 243, 0.8);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
        }

        .control-btn:active {
            background: rgba(25, 118, 210, 0.9);
            transform: scale(0.95);
        }

        .fire-btn {
            background: rgba(255, 87, 34, 0.8);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            position: fixed;
            bottom: 100px;
            right: 30px;
            font-size: 28px;
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.5);
        }

        .fire-btn:active {
            background: rgba(255, 87, 34, 0.95);
            transform: scale(0.95);
        }

        .angle-controls {
            display: flex;
            gap: 20px;
        }

        .angle-btn {
            width: 60px;
            height: 60px;
            background: rgba(156, 39, 176, 0.8);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
        }

        .angle-btn:active {
            background: rgba(123, 31, 162, 0.9);
            transform: scale(0.95);
        }

        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #87CEEB, #98D8E8);
            z-index: 2000;
            color: #333;
            text-align: center;
        }

        .start-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #1a237e;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
        }

        .start-screen p {
            font-size: 20px;
            margin-bottom: 30px;
            max-width: 600px;
            padding: 0 20px;
        }

        .controls-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: #333;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 10px;
        }

        .speed-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            color: #333;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .weapon-indicator {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            color: #333;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weapon-icon {
            font-size: 24px;
        }

        .damage-bar {
            width: 100px;
            height: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .damage-fill {
            height: 100%;
            background: linear-gradient(to right, #ff9800, #f44336);
            border-radius: 4px;
        }

        .aircraft-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .aircraft-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            width: 200px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .aircraft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .aircraft-card.selected {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            transform: scale(1.05);
        }

        .aircraft-name {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .aircraft-stats {
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .aircraft-stat {
            display: flex;
            justify-content: space-between;
        }

        .aircraft-preview {
            width: 100%;
            height: 80px;
            margin-top: 10px;
        }

        .weapon-stat {
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.2);
        }

        .weapon-bar {
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .weapon-bar-fill {
            height: 100%;
            border-radius: 3px;
        }

        .hit-effect {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(244, 67, 54, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .hit-effect.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .game-info {
                font-size: 16px;
            }
            
            .controls {
                bottom: 10px;
            }
            
            .control-btn, .angle-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .fire-btn {
                width: 60px;
                height: 60px;
                bottom: 80px;
                right: 20px;
                font-size: 24px;
            }
            
            .start-screen h1 {
                font-size: 36px;
            }
            
            .start-screen p {
                font-size: 18px;
            }
            
            .controls-hint {
                display: none;
            }
            
            .angle-controls {
                gap: 10px;
            }
            
            .speed-indicator {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .weapon-indicator {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .aircraft-card {
                width: 150px;
                padding: 10px;
            }
            
            .aircraft-preview {
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="start-screen" id="startScreen">
        <h1>ç©ºä¸­ä½¿å‘½</h1>
        <p>é€‰æ‹©ä½ çš„æˆ˜æ–—æœºï¼Œå¼€å§‹ç©ºä¸­æˆ˜æ–—ï¼ä½¿ç”¨ W/S æ§åˆ¶é€Ÿåº¦ï¼ŒA/D æ§åˆ¶è§’åº¦ï¼Œæ–¹å‘é”®æˆ–å±å¹•æŒ‰é’®æ§åˆ¶ä½ç½®ï¼Œç©ºæ ¼é”®æˆ–å³ä¸‹è§’æŒ‰é’®å°„å‡»ï¼</p>
        
        <div class="aircraft-selection" id="aircraftSelection">
            <!-- æˆ˜æ–—æœºé€‰æ‹©å¡ç‰‡å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
        </div>
        
        <button class="start-btn" id="startBtn" style="background: #ff5722; color: white; border: none; padding: 15px 40px; font-size: 24px; border-radius: 30px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div class="game-container">
        <div class="game-info">
            <div class="score">å¾—åˆ†: <span id="score">0</span></div>
            <div class="lives">ç”Ÿå‘½: <span id="lives">3</span></div>
            <div class="ammo">å¼¹è¯: <span id="ammo">âˆ</span></div>
        </div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>

    <div class="speed-indicator">é€Ÿåº¦: <span id="speedValue">100</span>%</div>
    
    <div class="weapon-indicator">
        <span class="weapon-icon">âš”ï¸</span>
        <span>æ”»å‡»åŠ›: <span id="damageValue">10</span></span>
        <div class="damage-bar">
            <div class="damage-fill" id="damageBar" style="width: 33%;"></div>
        </div>
    </div>

    <div class="controls">
        <div class="movement-controls">
            <div class="control-row">
                <div class="control-btn" id="upBtn">W</div>
            </div>
            <div class="control-row">
                <div class="control-btn" id="leftBtn">â†</div>
                <div class="control-btn" id="rightBtn">â†’</div>
            </div>
            <div class="control-row">
                <div class="control-btn" id="downBtn">S</div>
            </div>
        </div>
        
        <div class="angle-controls">
            <div class="angle-btn" id="leftAngleBtn">A</div>
            <div class="angle-btn" id="rightAngleBtn">D</div>
        </div>
    </div>

    <div class="control-btn fire-btn" id="fireBtn">ğŸ”¥</div>
    
    <div class="hit-effect" id="hitEffect"></div>

    <div class="controls-hint">
        ç”µè„‘: W/Sæ§åˆ¶é€Ÿåº¦, A/Dæ§åˆ¶è§’åº¦, æ–¹å‘é”®æ§åˆ¶ä½ç½®, ç©ºæ ¼é”®å°„å‡»<br>
        æ‰‹æœº: å±å¹•æŒ‰é’®æ§åˆ¶é€Ÿåº¦å’Œè§’åº¦, æ–¹å‘æŒ‰é’®æ§åˆ¶ä½ç½®, å³ä¸‹è§’æŒ‰é’®å°„å‡»
    </div>

    <div class="game-over-screen" id="gameOverScreen">
        <div class="game-over-content">
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></p>
            <p>æ‘§æ¯é˜²ç©ºç‚®: <span id="gunsDestroyed">0</span></p>
            <button class="restart-btn" id="restartBtn">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ¸¸æˆçŠ¶æ€
        let gameRunning = false;
        let score = 0;
        let lives = 3;
        let gameSpeed = 1;
        let animationId;
        let lastPlaneShot = 0;
        let planeShootInterval = 200; // é£æœºå°„å‡»é—´éš”(æ¯«ç§’)
        let gunsDestroyed = 0;
        let selectedAircraft = null;
        let hitEffectTimeout = null;
        
        // æˆ˜æ–—æœºæ¨¡å‹
        const aircraftModels = [
            {
                id: 'fighter',
                name: 'æˆ˜æ–—æœº',
                speed: 5,
                rotationSpeed: 0.08,
                color: '#1976d2',
                afterburnerColor: '#ff5722',
                trailColor: '#ff9800',
                weaponType: 'single',
                weapons: 2,
                damage: 10,
                weaponName: 'æ ‡å‡†åˆ¶å¯¼å¯¼å¼¹'
            },
            {
                id: 'bomber',
                name: 'è½°ç‚¸æœº',
                speed: 3,
                rotationSpeed: 0.05,
                color: '#4a148c',
                afterburnerColor: '#e91e63',
                trailColor: '#9c27b0',
                weaponType: 'spread',
                weapons: 4,
                damage: 15,
                weaponName: 'é›†æŸç‚¸å¼¹'
            },
            {
                id: 'interceptor',
                name: 'æ‹¦æˆªæœº',
                speed: 7,
                rotationSpeed: 0.1,
                color: '#0d47a1',
                afterburnerColor: '#00acc1',
                trailColor: '#00bcd4',
                weaponType: 'rapid',
                weapons: 1,
                damage: 20,
                weaponName: 'é«˜é€Ÿç©¿ç”²å¼¹'
            },
            {
                id: 'stealth',
                name: 'éšå½¢æˆ˜æœº',
                speed: 6,
                rotationSpeed: 0.07,
                color: '#263238',
                afterburnerColor: '#7e57c2',
                trailColor: '#5e35b1',
                weaponType: 'guided',
                weapons: 2,
                damage: 12,
                weaponName: 'ç²¾ç¡®åˆ¶å¯¼ç‚¸å¼¹'
            }
        ];
        
        // æ¸²æŸ“æˆ˜æ–—æœºé€‰æ‹©å¡ç‰‡
        function renderAircraftSelection() {
            const container = document.getElementById('aircraftSelection');
            container.innerHTML = '';
            
            aircraftModels.forEach((model, index) => {
                const card = document.createElement('div');
                card.className = `aircraft-card ${index === 0 ? 'selected' : ''}`;
                card.dataset.id = model.id;
                
                // è®¡ç®—æ­¦å™¨å¼ºåº¦ç™¾åˆ†æ¯”
                const damagePercent = (model.damage / 20) * 100;
                
                card.innerHTML = `
                    <div class="aircraft-name">${model.name}</div>
                    <div class="aircraft-stats">
                        <div class="aircraft-stat">
                            <span>é€Ÿåº¦:</span>
                            <span>${model.speed}/10</span>
                        </div>
                        <div class="aircraft-stat">
                            <span>æœºåŠ¨æ€§:</span>
                            <span>${Math.round(model.rotationSpeed * 100)}%</span>
                        </div>
                        <div class="aircraft-stat">
                            <span>æ­¦å™¨:</span>
                            <span>${model.weapons}</span>
                        </div>
                    </div>
                    <div class="weapon-stat">
                        <div class="aircraft-stat">
                            <span>æ”»å‡»åŠ›:</span>
                            <span>${model.damage}</span>
                        </div>
                        <div class="weapon-stat">
                            <div class="weapon-bar">
                                <div class="weapon-bar-fill" style="width: ${damagePercent}%; background: #f44336;"></div>
                            </div>
                        </div>
                        <div class="aircraft-stat">
                            <span>æ­¦å™¨ç±»å‹:</span>
                            <span>${model.weaponName}</span>
                        </div>
                    </div>
                    <canvas class="aircraft-preview" id="preview-${model.id}" width="180" height="80"></canvas>
                `;
                
                card.addEventListener('click', () => {
                    document.querySelectorAll('.aircraft-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedAircraft = model;
                });
                
                container.appendChild(card);
                
                // ç»˜åˆ¶é¢„è§ˆå›¾
                setTimeout(() => {
                    const previewCanvas = document.getElementById(`preview-${model.id}`);
                    if (previewCanvas) {
                        const pctx = previewCanvas.getContext('2d');
                        drawAircraftPreview(pctx, model, 90, 40);
                    }
                }, 100);
            });
            
            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€æ¶æˆ˜æ–—æœº
            selectedAircraft = aircraftModels[0];
        }
        
        // ç»˜åˆ¶æˆ˜æ–—æœºé¢„è§ˆå›¾
        function drawAircraftPreview(pctx, model, x, y) {
            pctx.save();
            pctx.translate(x, y);
            
            // æœºèº«
            pctx.fillStyle = model.color;
            pctx.beginPath();
            pctx.moveTo(0, -15);
            pctx.lineTo(-10, 10);
            pctx.lineTo(0, 5);
            pctx.lineTo(10, 10);
            pctx.closePath();
            pctx.fill();
            
            // æœºç¿¼
            pctx.fillStyle = model.color.replace('#', '#4') + '0';
            pctx.fillRect(-20, 0, 40, 5);
            
            // é©¾é©¶èˆ±
            pctx.fillStyle = '#64b5f6';
            pctx.beginPath();
            pctx.ellipse(0, -5, 3, 5, 0, 0, Math.PI * 2);
            pctx.fill();
            
            // æ­¦å™¨
            pctx.fillStyle = '#ffc107';
            for (let i = 0; i < model.weapons; i++) {
                const offsetX = (i - (model.weapons - 1) / 2) * 8;
                pctx.fillRect(offsetX - 1, -8, 2, 4);
            }
            
            // å¼•æ“å…‰æ™•
            pctx.shadowColor = model.afterburnerColor;
            pctx.shadowBlur = 10;
            pctx.fillStyle = model.afterburnerColor;
            pctx.beginPath();
            pctx.arc(0, 15, 5, 0, Math.PI * 2);
            pctx.fill();
            
            pctx.restore();
        }
        
        // æ˜¾ç¤ºå‡»ä¸­æ•ˆæœ
        function showHitEffect(damage) {
            const hitEffectEl = document.getElementById('hitEffect');
            hitEffectEl.textContent = `é€ æˆ ${damage} ç‚¹ä¼¤å®³!`;
            hitEffectEl.classList.add('show');
            
            if (hitEffectTimeout) {
                clearTimeout(hitEffectTimeout);
            }
            
            hitEffectTimeout = setTimeout(() => {
                hitEffectEl.classList.remove('show');
            }, 1000);
        }
        
        // è°ƒæ•´ç”»å¸ƒå¤§å°ä»¥é€‚åº”å±å¹•
        function resizeCanvas() {
            const maxWidth = window.innerWidth * 0.9;
            const maxHeight = window.innerHeight * 0.7;
            
            if (maxWidth < 800) {
                canvas.width = maxWidth;
                canvas.height = maxWidth * 0.75;
            }
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // é£æœºå¯¹è±¡
        const plane = {
            x: canvas.width / 2,
            y: canvas.height / 2,  // åˆå§‹ä½ç½®åœ¨å±å¹•ä¸­å¿ƒ
            width: 60,
            height: 60,
            baseSpeed: 5,
            currentSpeed: 5,
            angle: 0,  // é£æœºè§’åº¦ï¼ˆå¼§åº¦ï¼‰
            rotationSpeed: 0.08,  // æ—‹è½¬é€Ÿåº¦
            movingLeft: false,
            movingRight: false,
            movingUp: false,
            movingDown: false,
            turnLeft: false,
            turnRight: false,
            trail: [],  // é£æœºå°¾è¿¹
            afterburner: false,  // åŠ é€Ÿå™¨çŠ¶æ€
            model: null  // å½“å‰æˆ˜æ–—æœºæ¨¡å‹
        };
        
        // é˜²ç©ºç‚®æ•°ç»„
        let antiAircraftGuns = [];
        
        // ç©å®¶å­å¼¹æ•°ç»„
        let playerBullets = [];
        
        // æ•Œäººå­å¼¹æ•°ç»„
        let enemyBullets = [];
        
        // çˆ†ç‚¸ç²’å­æ•°ç»„
        let explosions = [];
        
        // äº‘æœµæ•°ç»„
        let clouds = [];
        
        // å¤ªé˜³å¯¹è±¡
        const sun = {
            x: canvas.width - 100,
            y: 100,
            radius: 40,
            rays: 12
        };
        
        // é˜²ç©ºç‚®çŠ¶æ€
        let activeGuns = [];
        
        // åˆå§‹åŒ–é˜²ç©ºç‚®
        function initAntiAircraftGuns() {
            antiAircraftGuns = [];
            const gunCount = 3;
            const spacing = canvas.width / (gunCount + 1);
            
            for (let i = 0; i < gunCount; i++) {
                const gun = {
                    x: spacing * (i + 1),
                    y: canvas.height - 30,
                    width: 40,
                    height: 40,
                    lastShot: 0,
                    shootInterval: 2000 + Math.random() * 1000,
                    angle: 0,
                    targetX: plane.x,
                    targetY: plane.y,
                    health: 3, // é˜²ç©ºç‚®ç”Ÿå‘½å€¼
                    maxHealth: 3,
                    lastHit: 0,
                    hitEffect: 0
                };
                antiAircraftGuns.push(gun);
                activeGuns.push(gun);
            }
        }
        
        // åˆå§‹åŒ–äº‘æœµ
        function initClouds() {
            clouds = [];
            for (let i = 0; i < 8; i++) {
                clouds.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height * 0.6,
                    width: 100 + Math.random() * 80,
                    height: 50 + Math.random() * 40,
                    speed: 0.2 + Math.random() * 0.3,
                    opacity: 0.7 + Math.random() * 0.3
                });
            }
        }
        
        // ç»˜åˆ¶å¤©ç©ºæ¸å˜èƒŒæ™¯
        function drawSky() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');  // å¤©è“è‰²
            gradient.addColorStop(0.5, '#98D8E8'); // æµ…è“è‰²
            gradient.addColorStop(1, '#B0E0E6');   // æ·¡è“è‰²
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // ç»˜åˆ¶å¤ªé˜³
        function drawSun() {
            ctx.save();
            ctx.translate(sun.x, sun.y);
            
            // å¤ªé˜³å…‰æ™•
            const glowGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, sun.radius * 2);
            glowGradient.addColorStop(0, 'rgba(255, 255, 0, 0.6)');
            glowGradient.addColorStop(1, 'rgba(255, 255, 0, 0)');
            ctx.fillStyle = glowGradient;
            ctx.beginPath();
            ctx.arc(0, 0, sun.radius * 2, 0, Math.PI * 2);
            ctx.fill();
            
            // å¤ªé˜³ä¸»ä½“
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(0, 0, sun.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // å¤ªé˜³å…‰çº¿
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            for (let i = 0; i < sun.rays; i++) {
                const angle = (i / sun.rays) * Math.PI * 2;
                const x1 = Math.cos(angle) * (sun.radius + 5);
                const y1 = Math.sin(angle) * (sun.radius + 5);
                const x2 = Math.cos(angle) * (sun.radius + 15);
                const y2 = Math.sin(angle) * (sun.radius + 15);
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶é£æœº
        function drawPlane() {
            if (!plane.model) return;
            
            // ç»˜åˆ¶é£æœºå°¾è¿¹
            if (plane.movingUp || plane.movingDown || plane.movingLeft || plane.movingRight || plane.turnLeft || plane.turnRight) {
                plane.trail.push({
                    x: plane.x - Math.sin(plane.angle) * plane.height / 2,
                    y: plane.y + Math.cos(plane.angle) * plane.height / 2
                });
                
                if (plane.trail.length > 20) {
                    plane.trail.shift();
                }
                
                plane.trail.forEach((point, index) => {
                    ctx.save();
                    ctx.globalAlpha = index / plane.trail.length * 0.7;
                    
                    // å°¾è¿¹é¢œè‰²æ ¹æ®é€Ÿåº¦å˜åŒ–
                    const afterburnerEffect = plane.afterburner ? 1.5 : 1;
                    const colorValue = Math.floor(128 + 127 * Math.sin(plane.angle) * afterburnerEffect);
                    const size = plane.afterburner ? 5 : 3;
                    
                    ctx.fillStyle = `rgb(255, ${colorValue}, 0)`;
                    
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, size * (index / plane.trail.length), 0, Math.PI * 2);
                    ctx.fill();
                    
                    // åŠ é€Ÿå™¨å°¾ç„°
                    if (plane.afterburner) {
                        ctx.fillStyle = `rgba(0, 150, 255, ${0.8 * (index / plane.trail.length)})`;
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, size * 1.5 * (index / plane.trail.length), 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.restore();
                });
            }
            
            ctx.save();
            ctx.translate(plane.x, plane.y);
            ctx.rotate(plane.angle);
            
            // æœºèº«
            ctx.fillStyle = plane.model.color;
            ctx.beginPath();
            ctx.moveTo(0, -plane.height / 2);
            ctx.lineTo(-plane.width / 3, plane.height / 3);
            ctx.lineTo(0, plane.height / 4);
            ctx.lineTo(plane.width / 3, plane.height / 3);
            ctx.closePath();
            ctx.fill();
            
            // æœºç¿¼
            ctx.fillStyle = plane.model.color.replace('#', '#4') + '0';
            ctx.fillRect(-plane.width / 2, 0, plane.width, plane.height / 6);
            
            // å°¾ç¿¼
            ctx.fillStyle = plane.model.color.replace('#', '#3') + '0';
            ctx.beginPath();
            ctx.moveTo(-plane.width / 6, plane.height / 4);
            ctx.lineTo(0, plane.height / 2);
            ctx.lineTo(plane.width / 6, plane.height / 4);
            ctx.closePath();
            ctx.fill();
            
            // é©¾é©¶èˆ±
            ctx.fillStyle = '#64b5f6';
            ctx.beginPath();
            ctx.ellipse(0, -plane.height / 4, plane.width / 8, plane.height / 6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // æ ¹æ®æ­¦å™¨ç±»å‹ç»˜åˆ¶æ­¦å™¨
            ctx.fillStyle = '#ffc107';
            if (plane.model.weapons === 1) {
                // æ‹¦æˆªæœºå•ç®¡æ­¦å™¨
                ctx.save();
                ctx.translate(-10, -plane.height / 4);
                ctx.rotate(plane.angle);
                ctx.fillRect(0, 0, 5, 15);
                ctx.restore();
                
                ctx.save();
                ctx.translate(10, -plane.height / 4);
                ctx.rotate(plane.angle);
                ctx.fillRect(-5, 0, 5, 15);
                ctx.restore();
            } else {
                // å¤šç®¡æ­¦å™¨
                for (let i = 0; i < plane.model.weapons; i++) {
                    const offsetX = (i - (plane.model.weapons - 1) / 2) * 8;
                    ctx.save();
                    ctx.translate(offsetX, -plane.height / 4);
                    ctx.rotate(plane.angle);
                    ctx.fillRect(-2.5, 0, 5, 15);
                    ctx.restore();
                }
            }
            
            // å¼•æ“å…‰æ™•
            if (plane.afterburner) {
                const exhaustX = -Math.sin(plane.angle) * plane.height / 2;
                const exhaustY = Math.cos(plane.angle) * plane.height / 2;
                
                // ä¸»å¼•æ“å…‰æ™•
                ctx.fillStyle = plane.model.afterburnerColor;
                ctx.globalAlpha = 0.8;
                ctx.beginPath();
                ctx.arc(exhaustX, exhaustY, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // åŠ é€Ÿå™¨å°¾ç„°
                ctx.fillStyle = '#00e5ff';
                ctx.globalAlpha = 0.6;
                ctx.beginPath();
                ctx.arc(exhaustX - Math.sin(plane.angle) * 10, 
                       exhaustY + Math.cos(plane.angle) * 10, 12, 0, Math.PI * 2);
                ctx.fill();
            } else if (plane.movingUp || plane.movingDown || plane.movingLeft || plane.movingRight || plane.turnLeft || plane.turnRight) {
                const exhaustX = -Math.sin(plane.angle) * plane.height / 2;
                const exhaustY = Math.cos(plane.angle) * plane.height / 2;
                
                ctx.fillStyle = plane.model.afterburnerColor;
                ctx.globalAlpha = 0.6;
                ctx.beginPath();
                ctx.arc(exhaustX, exhaustY, 10, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶é˜²ç©ºç‚®
        function drawAntiAircraftGun(gun) {
            ctx.save();
            ctx.translate(gun.x, gun.y);
            
            // åœ°é¢
            ctx.fillStyle = '#8d6e63';
            ctx.fillRect(-50, 0, 100, 15);
            
            // å—å‡»æ•ˆæœ
            if (gun.hitEffect > 0) {
                ctx.shadowColor = '#ff5722';
                ctx.shadowBlur = gun.hitEffect * 2;
                gun.hitEffect -= 0.1;
            }
            
            // ç‚®å°åº•åº§
            const damageRatio = gun.health / gun.maxHealth;
            const damageColor = damageRatio > 0.66 ? '#616161' : damageRatio > 0.33 ? '#757575' : '#9e9e9e';
            ctx.fillStyle = damageColor;
            ctx.fillRect(-gun.width / 2, -gun.height / 2, gun.width, gun.height / 2);
            
            // ç‚®ç®¡
            ctx.fillStyle = damageRatio > 0.66 ? '#424242' : damageRatio > 0.33 ? '#616161' : '#757575';
            ctx.fillRect(-5, -gun.height * 1.5, 10, gun.height * 1.5);
            
            // ç‚®ç®¡é¡¶éƒ¨
            ctx.beginPath();
            ctx.arc(0, -gun.height * 1.5, 8, 0, Math.PI * 2);
            ctx.fillStyle = damageRatio > 0.66 ? '#616161' : damageRatio > 0.33 ? '#757575' : '#9e9e9e';
            ctx.fill();
            
            // ç‚®å°æŒ‡ç¤ºç¯
            const indicatorColor = gun.health > 0 ? (Date.now() - gun.lastHit < 500 ? '#f44336' : '#4caf50') : '#f44336';
            ctx.fillStyle = indicatorColor;
            ctx.beginPath();
            ctx.arc(-gun.width / 4, -gun.height / 4, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // å¥åº·æ¡
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(-20, -gun.height / 2 - 15, 40, 5);
            
            // æ ¹æ®å—æŸç¨‹åº¦æ”¹å˜å¥åº·æ¡é¢œè‰²
            if (damageRatio > 0.66) {
                ctx.fillStyle = '#4caf50'; // ç»¿è‰² - å¥åº·çŠ¶æ€å¥½
            } else if (damageRatio > 0.33) {
                ctx.fillStyle = '#ff9800'; // æ©™è‰² - è½»å¾®å—æŸ
            } else {
                ctx.fillStyle = '#f44336'; // çº¢è‰² - ä¸¥é‡å—æŸ
            }
            
            ctx.fillRect(-20, -gun.height / 2 - 15, 40 * damageRatio, 5);
            
            // æ˜¾ç¤ºä¼¤å®³æ•°å­—
            if (gun.lastHit > Date.now() - 500) {
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`-${plane.model.damage}`, 0, -gun.height / 2 - 25);
            }
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶ç©å®¶å­å¼¹
        function drawPlayerBullet(bullet) {
            ctx.save();
            
            // å­å¼¹ä¸»ä½“
            ctx.fillStyle = '#00e676';
            ctx.shadowColor = '#00c853';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // å­å¼¹å°¾è¿¹
            ctx.fillStyle = 'rgba(0, 230, 118, 0.5)';
            ctx.beginPath();
            ctx.arc(bullet.x - bullet.vx * 2, bullet.y - bullet.vy * 2, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // å­å¼¹å…‰æ™•è¡¨ç¤ºæ”»å‡»åŠ›
            ctx.shadowBlur = 5;
            ctx.shadowColor = '#00e676';
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, 7, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶æ•Œäººå­å¼¹
        function drawEnemyBullet(bullet) {
            ctx.save();
            ctx.fillStyle = '#ff5722';
            ctx.shadowColor = '#ff3d00';
            ctx.shadowBlur = 8;
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
        
        // ç»˜åˆ¶äº‘æœµ
        function drawCloud(cloud) {
            ctx.save();
            ctx.globalAlpha = cloud.opacity;
            ctx.fillStyle = '#ffffff';
            
            ctx.beginPath();
            ctx.arc(cloud.x, cloud.y, cloud.height / 2, 0, Math.PI * 2);
            ctx.arc(cloud.x + cloud.width / 3, cloud.y - cloud.height / 4, cloud.height / 2.5, 0, Math.PI * 2);
            ctx.arc(cloud.x + cloud.width * 2/3, cloud.y, cloud.height / 2.2, 0, Math.PI * 2);
            ctx.arc(cloud.x + cloud.width / 1.5, cloud.y + cloud.height / 4, cloud.height / 3, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶çˆ†ç‚¸ç²’å­
        function drawExplosion(particle) {
            ctx.save();
            ctx.globalAlpha = particle.alpha;
            ctx.fillStyle = particle.color;
            ctx.beginPath();
            ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
            ctx.fill();
            
            // å¦‚æœç²’å­æ¯”è¾ƒå¤§ï¼Œæ˜¾ç¤ºæ”»å‡»åŠ›
            if (particle.size > 3 && particle.damage) {
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`-${particle.damage}`, particle.x, particle.y + 4);
            }
            
            ctx.restore();
        }
        
        // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
        function createExplosion(x, y, damage, color = '#ff5722') {
            for (let i = 0; i < 15; i++) {
                explosions.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    size: Math.random() * 5 + 2,
                    alpha: 1,
                    color: color,
                    damage: damage,
                    decay: 0.02
                });
            }
            
            // æ˜¾ç¤ºå‡»ä¸­æ•ˆæœ
            showHitEffect(damage);
        }
        
        // é£æœºå°„å‡»
        function planeShoot() {
            if (!plane.model) return;
            
            const now = Date.now();
            
            // æ ¹æ®æ­¦å™¨ç±»å‹è°ƒæ•´å°„å‡»é—´éš”
            let actualInterval = planeShootInterval;
            if (plane.model.weaponType === 'rapid') {
                actualInterval = 100; // æ‹¦æˆªæœºå°„å‡»æ›´å¿«
            } else if (plane.model.weaponType === 'spread') {
                actualInterval = 300; // è½°ç‚¸æœºå°„å‡»è¾ƒæ…¢
            }
            
            if (now - lastPlaneShot > actualInterval) {
                // æ ¹æ®é£æœºè§’åº¦è®¡ç®—å­å¼¹æ–¹å‘
                const bulletVX = Math.sin(plane.angle) * 8;
                const bulletVY = -Math.cos(plane.angle) * 8;
                
                if (plane.model.weaponType === 'single' || plane.model.weapons <= 2) {
                    // å•å‘æ­¦å™¨
                    playerBullets.push({
                        x: plane.x,
                        y: plane.y - plane.height / 2,
                        vx: bulletVX,
                        vy: bulletVY,
                        angle: plane.angle,
                        damage: plane.model.damage
                    });
                } else if (plane.model.weaponType === 'spread') {
                    // æ•£å°„æ­¦å™¨
                    const spreadAngle = Math.PI / 12; // 360åº¦çš„æ‰©æ•£è§’
                    for (let i = 0; i < plane.model.weapons; i++) {
                        const angleOffset = (i - (plane.model.weapons - 1) / 2) * spreadAngle * 2;
                        const spreadVX = Math.sin(plane.angle + angleOffset) * 8;
                        const spreadVY = -Math.cos(plane.angle + angleOffset) * 8;
                        
                        playerBullets.push({
                            x: plane.x + (i - (plane.model.weapons - 1) / 2) * 8,
                            y: plane.y - plane.height / 2,
                            vx: spreadVX,
                            vy: spreadVY,
                            angle: plane.angle + angleOffset,
                            damage: plane.model.damage
                        });
                    }
                } else {
                    // æ ‡å‡†æ­¦å™¨
                    playerBullets.push({
                        x: plane.x,
                        y: plane.y - plane.height / 2,
                        vx: bulletVX,
                        vy: bulletVY,
                        angle: plane.angle,
                        damage: plane.model.damage
                    });
                }
                
                lastPlaneShot = now;
            }
        }
        
        // æ›´æ–°é£æœºä½ç½®
        function updatePlane() {
            if (!plane.model) return;
            
            // æ ¹æ®æŒ‰é”®è°ƒæ•´é€Ÿåº¦
            if (plane.movingUp) {
                plane.currentSpeed = plane.model.speed * 1.5;
                plane.afterburner = true;
            } else if (plane.movingDown) {
                plane.currentSpeed = plane.model.speed * 0.5;
                plane.afterburner = false;
            } else {
                plane.currentSpeed = plane.model.speed;
                plane.afterburner = false;
            }
            
            // æ›´æ–°é£æœºè§’åº¦ï¼ˆ360åº¦æ—‹è½¬ï¼‰
            if (plane.turnLeft) {
                plane.angle -= plane.rotationSpeed;
            }
            if (plane.turnRight) {
                plane.angle += plane.rotationSpeed;
            }
            
            // ä¿æŒè§’åº¦åœ¨0-2Ï€èŒƒå›´å†…
            if (plane.angle > Math.PI * 2) {
                plane.angle -= Math.PI * 2;
            } else if (plane.angle < 0) {
                plane.angle += Math.PI * 2;
            }
            
            // è®¡ç®—ç§»åŠ¨æ–¹å‘
            let dx = 0;
            let dy = 0;
            
            if (plane.movingLeft) {
                dx -= plane.currentSpeed;
            }
            if (plane.movingRight) {
                dx += plane.currentSpeed;
            }
            if (plane.movingUp) {
                dy -= plane.currentSpeed;
            }
            if (plane.movingDown) {
                dy += plane.currentSpeed;
            }
            
            // åº”ç”¨è§’åº¦å˜æ¢
            const rotatedDx = dx * Math.cos(plane.angle) - dy * Math.sin(plane.angle);
            const rotatedDy = dx * Math.sin(plane.angle) + dy * Math.cos(plane.angle);
            
            // æ›´æ–°é£æœºä½ç½®ï¼ˆå¹¶è€ƒè™‘å±å¹•è¾¹ç•Œï¼‰
            if (plane.x + rotatedDx > 0 && plane.x + rotatedDx < canvas.width) {
                plane.x += rotatedDx;
            }
            if (plane.y + rotatedDy > 0 && plane.y + rotatedDy < canvas.height) {
                plane.y += rotatedDy;
            }
            
            // å¦‚æœé£æœºç§»å‡ºå±å¹•ä¸€ä¾§ï¼Œä¼šä»å¦ä¸€ä¾§å‡ºç°
            if (plane.x < 0) plane.x = canvas.width;
            if (plane.x > canvas.width) plane.x = 0;
            if (plane.y < 0) plane.y = canvas.height;
            if (plane.y > canvas.height) plane.y = 0;
            
            // æ›´æ–°é€Ÿåº¦æŒ‡ç¤ºå™¨
            const speedPercent = Math.round((plane.currentSpeed / plane.model.speed) * 100);
            document.getElementById('speedValue').textContent = speedPercent;
        }
        
        // æ›´æ–°é˜²ç©ºç‚®
        function updateAntiAircraftGuns() {
            const now = Date.now();
            
            activeGuns.forEach(gun => {
                // è®¡ç®—æœå‘é£æœºçš„è§’åº¦
                const dx = plane.x - gun.x;
                const dy = plane.y - gun.y;
                gun.angle = Math.atan2(dy, dx) + Math.PI / 2;
                
                // å‘å°„å­å¼¹
                if (now - gun.lastShot > gun.shootInterval && gun.health > 0) {
                    const bulletSpeed = 4;
                    enemyBullets.push({
                        x: gun.x,
                        y: gun.y,
                        vx: Math.sin(gun.angle) * bulletSpeed,
                        vy: -Math.cos(gun.angle) * bulletSpeed,
                        fromGun: gun
                    });
                    gun.lastShot = now;
                    gun.shootInterval = 1500 + Math.random() * 1000;
                }
            });
        }
        
        // æ›´æ–°ç©å®¶å­å¼¹
        function updatePlayerBullets() {
            playerBullets = playerBullets.filter(bullet => {
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                
                // æ£€æŸ¥æ˜¯å¦å‡»ä¸­é˜²ç©ºç‚®
                for (let i = 0; i < activeGuns.length; i++) {
                    const gun = activeGuns[i];
                    if (gun.health > 0) {
                        const dx = bullet.x - gun.x;
                        const dy = bullet.y - gun.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < gun.width / 2) {
                            // æ ¹æ®æ”»å‡»åŠ›è®¡ç®—ä¼¤å®³
                            const damage = bullet.damage;
                            gun.health -= damage;
                            gun.lastHit = Date.now();
                            gun.hitEffect = 1;
                            
                            if (gun.health <= 0) {
                                // åˆ›å»ºçˆ†ç‚¸ï¼Œä¼ é€’æ”»å‡»åŠ›
                                createExplosion(gun.x, gun.y, damage, '#4caf50');
                                score += 100;
                                gunsDestroyed++;
                                activeGuns.splice(i, 1);
                                
                                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é˜²ç©ºç‚®éƒ½è¢«æ‘§æ¯
                                if (activeGuns.length === 0) {
                                    // ç”Ÿæˆæ–°çš„é˜²ç©ºç‚®
                                    setTimeout(() => {
                                        initAntiAircraftGuns();
                                        score += 500; // å¥–åŠ±åˆ†æ•°
                                    }, 2000);
                                }
                            } else {
                                // åˆ›å»ºçˆ†ç‚¸ï¼Œä¼ é€’æ”»å‡»åŠ›
                                createExplosion(gun.x, gun.y, damage, '#ff9800');
                            }
                            
                            return false; // ç§»é™¤å­å¼¹
                        }
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºç”»å¸ƒ
                if (bullet.x < -10 || bullet.x > canvas.width + 10 || 
                    bullet.y < -10 || bullet.y > canvas.height + 10) {
                    return false;
                }
                
                return true;
            });
        }
        
        // æ›´æ–°æ•Œäººå­å¼¹
        function updateEnemyBullets() {
            enemyBullets = enemyBullets.filter(bullet => {
                bullet.x += bullet.vx * gameSpeed;
                bullet.y += bullet.vy * gameSpeed;
                
                // æ£€æŸ¥æ˜¯å¦å‡»ä¸­é£æœº
                const dx = bullet.x - plane.x;
                const dy = bullet.y - plane.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < plane.width / 2) {
                    lives--;
                    document.getElementById('lives').textContent = lives;
                    createExplosion(plane.x, plane.y, 5, '#f44336');
                    
                    if (lives <= 0) {
                        gameOver();
                    }
                    
                    return false; // ç§»é™¤å­å¼¹
                }
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºç”»å¸ƒ
                if (bullet.x < -10 || bullet.x > canvas.width + 10 || 
                    bullet.y < -10 || bullet.y > canvas.height + 10) {
                    return false;
                }
                
                return true;
            });
        }
        
        // æ›´æ–°äº‘æœµ
        function updateClouds() {
            clouds.forEach(cloud => {
                cloud.x -= cloud.speed;
                
                // å¦‚æœäº‘æœµç§»å‡ºç”»å¸ƒï¼Œé‡æ–°æ”¾ç½®åˆ°å³ä¾§
                if (cloud.x + cloud.width < 0) {
                    cloud.x = canvas.width + cloud.width;
                    cloud.y = Math.random() * canvas.height * 0.6;
                }
            });
        }
        
        // æ›´æ–°çˆ†ç‚¸ç²’å­
        function updateExplosions() {
            explosions = explosions.filter(particle => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.alpha -= particle.decay;
                particle.size *= 0.98;
                
                return particle.alpha > 0;
            });
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameRunning) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å¤©ç©ºèƒŒæ™¯
            drawSky();
            
            // ç»˜åˆ¶å¤ªé˜³
            drawSun();
            
            // ç»˜åˆ¶å’Œæ›´æ–°äº‘æœµ
            updateClouds();
            clouds.forEach(cloud => drawCloud(cloud));
            
            // æ›´æ–°æ¸¸æˆå¯¹è±¡
            updatePlane();
            planeShoot(); // é£æœºæŒç»­å°„å‡»
            updateAntiAircraftGuns();
            updatePlayerBullets();
            updateEnemyBullets();
            updateExplosions();
            
            // ç»˜åˆ¶æ¸¸æˆå¯¹è±¡
            antiAircraftGuns.forEach(gun => drawAntiAircraftGun(gun));
            drawPlane();
            playerBullets.forEach(bullet => drawPlayerBullet(bullet));
            enemyBullets.forEach(bullet => drawEnemyBullet(bullet));
            explosions.forEach(particle => drawExplosion(particle));
            
            // æ›´æ–°åˆ†æ•°
            score += 1;
            document.getElementById('score').textContent = score;
            
            // é€æ¸æé«˜æ¸¸æˆé€Ÿåº¦
            gameSpeed = 1 + score / 5000;
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            animationId = requestAnimationFrame(gameLoop);
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gunsDestroyed').textContent = gunsDestroyed;
            document.getElementById('gameOverScreen').style.display = 'flex';
        }
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            score = 0;
            lives = 3;
            gameSpeed = 1;
            playerBullets = [];
            enemyBullets = [];
            explosions = [];
            plane.trail = [];
            gunsDestroyed = 0;
            activeGuns = [];
            
            plane.x = canvas.width / 2;
            plane.y = canvas.height / 2;
            plane.angle = 0;
            plane.currentSpeed = plane.model ? plane.model.speed : 5;
            plane.afterburner = false;
            
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            document.getElementById('speedValue').textContent = plane.model ? 100 : 100;
            document.getElementById('gameOverScreen').style.display = 'none';
            
            initAntiAircraftGuns();
            initClouds();
            
            gameRunning = true;
            gameLoop();
        }
        
        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            
            switch(e.key.toLowerCase()) {
                case 'arrowleft':
                    plane.movingLeft = true;
                    break;
                case 'arrowright':
                    plane.movingRight = true;
                    break;
                case 'arrowup':
                    plane.movingUp = true;
                    break;
                case 'arrowdown':
                    plane.movingDown = true;
                    break;
                case 'w':
                    plane.movingUp = true;
                    break;
                case 's':
                    plane.movingDown = true;
                    break;
                case 'a':
                    plane.turnLeft = true;
                    break;
                case 'd':
                    plane.turnRight = true;
                    break;
                case ' ':
                    e.preventDefault();
                    planeShoot();
                    break;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            switch(e.key.toLowerCase()) {
                case 'arrowleft':
                    plane.movingLeft = false;
                    break;
                case 'arrowright':
                    plane.movingRight = false;
                    break;
                case 'arrowup':
                    plane.movingUp = false;
                    break;
                case 'arrowdown':
                    plane.movingDown = false;
                    break;
                case 'w':
                    plane.movingUp = false;
                    break;
                case 's':
                    plane.movingDown = false;
                    break;
                case 'a':
                    plane.turnLeft = false;
                    break;
                case 'd':
                    plane.turnRight = false;
                    break;
            }
        });
        
        // è§¦æ‘¸æ§åˆ¶
        const upBtn = document.getElementById('upBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const downBtn = document.getElementById('downBtn');
        const leftAngleBtn = document.getElementById('leftAngleBtn');
        const rightAngleBtn = document.getElementById('rightAngleBtn');
        const fireBtn = document.getElementById('fireBtn');
        
        // é¼ æ ‡/è§¦æ‘¸æ§åˆ¶
        upBtn.addEventListener('mousedown', () => {
            plane.movingUp = true;
            plane.movingDown = false;
        });
        upBtn.addEventListener('mouseup', () => plane.movingUp = false);
        
        leftBtn.addEventListener('mousedown', () => plane.movingLeft = true);
        leftBtn.addEventListener('mouseup', () => plane.movingLeft = false);
        
        rightBtn.addEventListener('mousedown', () => plane.movingRight = true);
        rightBtn.addEventListener('mouseup', () => plane.movingRight = false);
        
        downBtn.addEventListener('mousedown', () => {
            plane.movingDown = true;
            plane.movingUp = false;
        });
        downBtn.addEventListener('mouseup', () => plane.movingDown = false);
        
        leftAngleBtn.addEventListener('mousedown', () => plane.turnLeft = true);
        leftAngleBtn.addEventListener('mouseup', () => plane.turnLeft = false);
        
        rightAngleBtn.addEventListener('mousedown', () => plane.turnRight = true);
        rightAngleBtn.addEventListener('mouseup', () => plane.turnRight = false);
        
        // å°„å‡»æŒ‰é’®
        fireBtn.addEventListener('mousedown', planeShoot);
        fireBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            planeShoot();
        });
        
        // é˜²æ­¢æŒ‰é’®åœ¨è§¦æ‘¸ç¦»å¼€å±å¹•åä»è¢«æŒ‰ä¸‹
        document.addEventListener('touchend', (e) => {
            if (!e.target.closest('.control-btn') && !e.target.closest('.fire-btn') && !e.target.closest('.angle-btn')) {
                plane.movingLeft = false;
                plane.movingRight = false;
                plane.movingUp = false;
                plane.movingDown = false;
                plane.turnLeft = false;
                plane.turnRight = false;
            }
        });
        
        // å¼€å§‹æ¸¸æˆæŒ‰é’®
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!selectedAircraft) {
                selectedAircraft = aircraftModels[0];
            }
            
            // åº”ç”¨é€‰ä¸­çš„æˆ˜æ–—æœºæ¨¡å‹
            plane.model = selectedAircraft;
            plane.baseSpeed = selectedAircraft.speed;
            plane.rotationSpeed = selectedAircraft.rotationSpeed;
            
            // æ›´æ–°æ”»å‡»åŠ›æ˜¾ç¤º
            document.getElementById('damageValue').textContent = plane.model.damage;
            document.getElementById('damageBar').style.width = `${(plane.model.damage / 20) * 100}%`;
            
            document.getElementById('startScreen').style.display = 'none';
            initAntiAircraftGuns();
            initClouds();
            gameRunning = true;
            gameLoop();
        });
        
        // é‡æ–°å¼€å§‹æŒ‰é’®
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        
        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.control-btn') || e.target.closest('.fire-btn') || e.target.closest('.angle-btn')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // åˆå§‹åŒ–æˆ˜æ–—æœºé€‰æ‹©ç•Œé¢
        renderAircraftSelection();
    </script>
</body>
</html>
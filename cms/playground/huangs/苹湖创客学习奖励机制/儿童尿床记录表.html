<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>å„¿ç«¥å°¿åºŠè®°å½•è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #a8edea, #fed6e3);
      font-family: "Microsoft YaHei", sans-serif;
      padding: 20px;
    }
    .card {
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .form-check-input:checked {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(13,110,253,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4 fw-bold text-primary">å„¿ç«¥å°¿åºŠè®°å½•è¡¨</h2>
    <div class="card p-4 mb-4">
      <form id="recordForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">æ—¥æœŸ</label>
            <input type="date" id="date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">æ‰€åœ¨åŸå¸‚</label>
            <input type="text" id="city" class="form-control" placeholder="è‡ªåŠ¨å®šä½ä¸­...">
          </div>
          <div class="col-md-6">
            <label class="form-label">å¤©æ°”æƒ…å†µ</label>
            <input type="text" id="weather" class="form-control" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">æ°”æ¸©</label>
            <input type="text" id="temperature" class="form-control" readonly placeholder="æœ€é«˜ / æœ€ä½ / å½“å‰ â„ƒ">
          </div>
          <div class="col-md-6">
            <label class="form-label">æ˜¯å¦å°¿åºŠ</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="bedwet" value="æ˜¯" required>
              <label class="form-check-label">æ˜¯</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="bedwet" value="å¦">
              <label class="form-check-label">å¦</label>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">ç¡è§‰æ—¶é—´ / èµ·åºŠæ—¶é—´</label>
            <div class="d-flex gap-2">
              <input type="time" id="sleepTime" class="form-control">
              <input type="time" id="wakeTime" class="form-control">
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">ç¡å‰è¡Œä¸º</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="toilet" value="ä¸Šå•æ‰€">
              <label class="form-check-label">ä¸Šå•æ‰€</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="drink" value="å–æ°´">
              <label class="form-check-label">å–æ°´</label>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">æ˜¯å¦è‡ªå·±æ´—è¡£ / è¢«å­</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="cloth" value="æ´—è¡£æœ">
              <label class="form-check-label">æ´—è¡£æœ</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="quilt" value="æ´—è¢«å­">
              <label class="form-check-label">æ´—è¢«å­</label>
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary mt-4 w-100">ä¿å­˜è®°å½•</button>
      </form>
    </div>

    <div class="card p-4">
      <h4 class="text-center mb-3">å†å²è®°å½•</h4>
      <input type="text" id="search" class="form-control mb-3" placeholder="ğŸ” è¾“å…¥å…³é”®è¯æœç´¢...">
      <table class="table table-bordered table-hover align-middle text-center">
        <thead class="table-primary">
          <tr>
            <th>æ—¥æœŸ</th>
            <th>å¤©æ°”</th>
            <th>å°¿åºŠ</th>
            <th>ç¡çœ </th>
            <th>ç¡å‰è¡Œä¸º</th>
            <th>è‡ªç†</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="historyTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    const dataFile = "data.json";
    let records = [];

    document.getElementById("date").valueAsDate = new Date();

    // ===== è‡ªåŠ¨å®šä½ + å¤©æ°” =====
    async function getWeather() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;

        // è·å–å¤©æ°”
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
        const res = await fetch(url);
        const data = await res.json();

        // å½“å‰å¤©æ°”
        const weatherCode = data.current_weather.weathercode;
        const codeMap = {
          0: "æ™´",
          1: "å¤šäº‘",
          2: "é˜´",
          3: "å°é›¨",
          45: "é›¾",
          48: "é›¾",
          51: "æ¯›æ¯›é›¨",
          61: "å°é›¨",
          63: "ä¸­é›¨",
          65: "å¤§é›¨",
          71: "å°é›ª",
          73: "ä¸­é›ª",
          75: "å¤§é›ª"
        };
        const weather = codeMap[weatherCode] || "ä¸æ˜";
        const tmax = data.daily.temperature_2m_max[0];
        const tmin = data.daily.temperature_2m_min[0];
        const tcur = data.current_weather.temperature;

        document.getElementById("weather").value = weather;
        document.getElementById("temperature").value = `${tmax}â„ƒ / ${tmin}â„ƒ ï¼ˆå½“å‰${tcur}â„ƒï¼‰`;

        // è·å–åŸå¸‚åç§°ï¼ˆç®€æ˜“ï¼‰
        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=zh`)
          .then(r => r.json())
          .then(addr => {
            document.getElementById("city").value = addr.city || addr.locality || addr.principalSubdivision || "æœªçŸ¥åŸå¸‚";
          });
      });
    }
    getWeather();

    // ===== åŠ è½½ã€ä¿å­˜ã€æ¸²æŸ“ =====
    async function loadData() {
      try {
        const res = await fetch(dataFile + "?t=" + Date.now());
        if (!res.ok) return;
        records = await res.json();
        renderTable(records);
      } catch {
        records = [];
      }
    }

    async function saveData() {
      const blob = new Blob([JSON.stringify(records, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "data.json";
      a.click();
    }

    function renderTable(list) {
      const tbody = document.getElementById("historyTable");
      tbody.innerHTML = "";
      list.forEach((r, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.city}<br>${r.weather} ${r.temperature}</td>
          <td>${r.bedwet}</td>
          <td>${r.sleepTime}~${r.wakeTime}</td>
          <td>${r.sleepActions}</td>
          <td>${r.selfCare}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick="editRecord(${i})">ç¼–è¾‘</button>
            <button class="btn btn-sm btn-danger" onclick="deleteRecord(${i})">åˆ é™¤</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // ===== æäº¤è¡¨å• =====
    document.getElementById("recordForm").addEventListener("submit", e => {
      e.preventDefault();
      const newRecord = {
        date: date.value,
        city: city.value,
        weather: weather.value,
        temperature: temperature.value,
        bedwet: document.querySelector("input[name='bedwet']:checked")?.value || "",
        sleepTime: sleepTime.value,
        wakeTime: wakeTime.value,
        sleepActions: [toilet.checked ? "ä¸Šå•æ‰€" : "", drink.checked ? "å–æ°´" : ""].filter(Boolean).join("ã€"),
        selfCare: [cloth.checked ? "æ´—è¡£æœ" : "", quilt.checked ? "æ´—è¢«å­" : ""].filter(Boolean).join("ã€")
      };
      records.push(newRecord);
      renderTable(records);
      saveData();
      e.target.reset();
      date.valueAsDate = new Date();
    });

    function deleteRecord(i) {
      if (confirm("ç¡®è®¤åˆ é™¤è¯¥è®°å½•ï¼Ÿ")) {
        records.splice(i, 1);
        renderTable(records);
        saveData();
      }
    }

    function editRecord(i) {
      const r = records[i];
      date.value = r.date;
      city.value = r.city;
      weather.value = r.weather;
      temperature.value = r.temperature;
      document.querySelectorAll("input[name='bedwet']").forEach(radio => radio.checked = radio.value === r.bedwet);
      sleepTime.value = r.sleepTime;
      wakeTime.value = r.wakeTime;
      toilet.checked = r.sleepActions.includes("ä¸Šå•æ‰€");
      drink.checked = r.sleepActions.includes("å–æ°´");
      cloth.checked = r.selfCare.includes("æ´—è¡£æœ");
      quilt.checked = r.selfCare.includes("æ´—è¢«å­");
      records.splice(i, 1);
      renderTable(records);
    }

    document.getElementById("search").addEventListener("input", e => {
      const kw = e.target.value.toLowerCase();
      renderTable(records.filter(r => JSON.stringify(r).toLowerCase().includes(kw)));
    });

    loadData();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é»„è¿å·¡å„¿ç«¥å°¿åºŠè®°å½•è¡¨</title>
<link href="bootstrap.min.css" rel="stylesheet">
<script src="bootstrap.bundle.min.js"></script>

<style>
body { background: #f7f9fc; font-family: "Microsoft YaHei", sans-serif; }
.card { box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px; margin-bottom: 20px; }
.btn-primary { background: #4e73df; border: none; }
</style>
</head>
<body class="p-3">
<div class="container">
  <h3 class="text-center mb-3">ğŸŒ™ é»„è¿å·¡å„¿ç«¥å°¿åºŠè®°å½•è¡¨</h3>

  <div class="card p-3">
    <form id="recordForm">
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">æ—¥æœŸ</label>
          <input type="date" class="form-control" id="date" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">åŸå¸‚</label>
          <div class="input-group">
            <input type="text" class="form-control" id="city" placeholder="å¦‚ï¼šè¥„é˜³" required>
            <button class="btn btn-outline-secondary" type="button" id="getWeatherBtn">è·å–å¤©æ°”</button>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">å¤©æ°”</label>
          <input type="text" class="form-control" id="weather">
        </div>
        <div class="col-md-4">
          <label class="form-label">æœ€é«˜æ¸©</label>
          <input type="text" class="form-control" id="tempMax">
        </div>
        <div class="col-md-4">
          <label class="form-label">æœ€ä½æ¸©</label>
          <input type="text" class="form-control" id="tempMin">
        </div>
        <div class="col-md-4">
          <label class="form-label">å½“å‰æ¸©</label>
          <input type="text" class="form-control" id="tempNow">
        </div>

        <!-- âœ… æ–°å¢ ç¡è§‰åœ°ç‚¹å•é€‰é¡¹ -->
        <div class="col-12">
          <label class="form-label d-block">ç¡è§‰åœ°ç‚¹</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sleepPlace" id="place1" value="è«å®¶æ²³">
            <label class="form-check-label" for="place1">è«å®¶æ²³</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sleepPlace" id="place2" value="åŸå†…å°å­¦">
            <label class="form-check-label" for="place2">åŸå†…å°å­¦</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sleepPlace" id="place3" value="åˆ›å®¢ç©ºé—´">
            <label class="form-check-label" for="place3">åˆ›å®¢ç©ºé—´</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sleepPlace" id="place4" value="æœæœå®¶">
            <label class="form-check-label" for="place4">æœæœå®¶</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sleepPlace" id="place5" value="å´é˜¿å§¨å®¶">
            <label class="form-check-label" for="place5">å´é˜¿å§¨å®¶</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sleepPlace" id="place6" value="å…¶å®ƒ">
            <label class="form-check-label" for="place6">å…¶å®ƒ</label>
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">æ˜¯å¦å°¿åºŠ</label>
          <select class="form-select" id="bedwetting">
            <option value="å¦">å¦</option>
            <option value="æ˜¯">æ˜¯</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">ç¡å‰ä¸Šå•æ‰€</label>
          <select class="form-select" id="toilet">
            <option value="æ˜¯">æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">ç¡å‰å–æ°´</label>
          <select class="form-select" id="drink">
            <option value="å¦">å¦</option>
            <option value="æ˜¯">æ˜¯</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">ç¡è§‰æ—¶é—´</label>
          <input type="time" class="form-control" id="sleepTime">
        </div>
        <div class="col-md-4">
          <label class="form-label">èµ·åºŠæ—¶é—´</label>
          <input type="time" class="form-control" id="wakeTime" value="07:00">
        </div>
        <div class="col-md-6">
          <label class="form-label">å¤‡æ³¨</label>
          <input type="text" class="form-control" id="remark">
        </div>
      </div>
      <div class="mt-3 text-end">
        <button type="submit" class="btn btn-primary">ä¿å­˜è®°å½•</button>
      </div>
    </form>
  </div>

  <div class="card p-3">
    <h5>ğŸ“‹ å†å²è®°å½•</h5>
    <input type="text" id="searchInput" class="form-control mb-2" placeholder="æœç´¢åŸå¸‚æˆ–æ—¥æœŸ...">
    <div class="table-responsive">
      <table class="table table-striped" id="recordTable">
        <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>åŸå¸‚</th><th>åœ°ç‚¹</th><th>å¤©æ°”</th><th>å°¿åºŠ</th><th>ç¡è§‰</th><th>èµ·åºŠ</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ====== å¤©æ°”æ¥å£ï¼ˆä½¿ç”¨ wttr.inï¼‰======
document.getElementById('getWeatherBtn').addEventListener('click', async () => {
  const city = document.getElementById('city').value.trim();
  if (!city) return alert("è¯·å¡«å†™åŸå¸‚åç§°");
  try {
    const res = await fetch(`weather.php?city=${encodeURIComponent(city)}`);
    if (!res.ok) throw new Error("ç½‘ç»œé”™è¯¯");
    const data = await res.json();
    document.getElementById('weather').value = data.weather || "æœªçŸ¥";
    document.getElementById('tempNow').value = data.temp || "";
    document.getElementById('tempMax').value = data.temp || "";
    document.getElementById('tempMin').value = data.temp || "";
  } catch (e) {
    alert("å¤©æ°”è·å–å¤±è´¥: " + e.message);
  }
});

// ====== ä¿å­˜ä¸ç¼–è¾‘é€»è¾‘ ======
let editingId = null;

document.getElementById('recordForm').addEventListener('submit', async e => {
  e.preventDefault();

  const place = document.querySelector('input[name="sleepPlace"]:checked');
  const record = {
    id: editingId || Date.now(),
    date: date.value,
    city: city.value,
    sleepPlace: place ? place.value : "",
    weather: weather.value,
    tempMax: tempMax.value,
    tempMin: tempMin.value,
    tempNow: tempNow.value,
    bedwetting: bedwetting.value,
    toilet: toilet.value,
    drink: drink.value,
    sleepTime: sleepTime.value,
    wakeTime: wakeTime.value,
    remark: remark.value
  };

  const res = await fetch('save.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({action: editingId ? "edit" : "add", record})
  });
  const data = await res.json();
  if (data.success) {
    loadRecords();
    document.getElementById('recordForm').reset();
    document.getElementById('wakeTime').value = "07:00";
    editingId = null;
  } else {
    alert("ä¿å­˜å¤±è´¥");
  }
});

async function loadRecords() {
  const res = await fetch('save.php?action=list');
  const data = await res.json();
  renderTable(data);
}

function renderTable(list) {
  const tbody = document.querySelector('#recordTable tbody');
  tbody.innerHTML = '';
  const search = document.getElementById('searchInput').value.trim();
  list.filter(r => !search || r.city.includes(search) || r.date.includes(search)).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.city}</td><td>${r.sleepPlace || ""}</td>
      <td>${r.weather}</td><td>${r.bedwetting}</td>
      <td>${r.sleepTime}</td><td>${r.wakeTime}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1" onclick='editRecord(${r.id})'>ç¼–è¾‘</button>
        <button class="btn btn-sm btn-outline-danger" onclick='deleteRecord(${r.id})'>åˆ é™¤</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('searchInput').addEventListener('input', loadRecords);

async function editRecord(id) {
  const res = await fetch('save.php?action=list');
  const data = await res.json();
  const rec = data.find(r => r.id == id);
  if (!rec) return;

  for (let k in rec) {
    if (document.getElementById(k)) document.getElementById(k).value = rec[k];
  }

  // é€‰ä¸­å¯¹åº”çš„ç¡è§‰åœ°ç‚¹
  if (rec.sleepPlace) {
    const radio = document.querySelector(`input[name="sleepPlace"][value="${rec.sleepPlace}"]`);
    if (radio) radio.checked = true;
  }

  editingId = id;
}

async function deleteRecord(id) {
  if (!confirm("ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ")) return;
  const res = await fetch('save.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({action: "delete", id})
  });
  const data = await res.json();
  if (data.success) loadRecords();
}

loadRecords();
</script>
</body>
</html>
